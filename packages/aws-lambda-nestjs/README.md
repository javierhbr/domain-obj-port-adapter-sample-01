# AWS Lambda with NestJS (`aws-lambda-nestjs`)

This package provides an AWS Lambda implementation using the NestJS framework for the transaction API. It utilizes the `core-domain` package for business logic and leverages NestJS features like dependency injection, modules, controllers, and validation pipes.

## Building

To build this package independently (using the NestJS CLI and copying the SAM template), navigate to this directory (`packages/aws-lambda-nestjs`) and run:

```bash
pnpm build
```

This uses `nest build` to compile the TypeScript code to the `dist` directory and then copies the `template.yaml` file into `dist`.

Alternatively, you can build it from the monorepo root:

```bash
# From /Users/javierbenavides/others/dev/poc/domain-obj-port-adapter-sample
pnpm --filter aws-lambda-nestjs build
```

Or build all packages:

```bash
# From /Users/javierbenavides/others/dev/poc/domain-obj-port-adapter-sample
pnpm build
```

## Testing

This package includes standard NestJS testing setup (`jest`), but currently only contains placeholder tests generated by the NestJS CLI. The `test` script in `package.json` runs these tests.

```bash
# Run tests from this directory
pnpm test

# Run tests from the monorepo root
# From /Users/javierbenavides/others/dev/poc/domain-obj-port-adapter-sample
pnpm --filter aws-lambda-nestjs test
```

You can also test the endpoints manually after running the service (see below).

## Running

### Without AWS SAM (using NestJS CLI / Node)

This method runs the NestJS application directly, either using the development server or the compiled JavaScript.

1.  **Build the project:** (Required for `start:nestjs`, optional for `dev:nestjs`)
    ```bash
    # From /Users/javierbenavides/others/dev/poc/domain-obj-port-adapter-sample
    pnpm build
    ```
2.  **Start the production build:**
    ```bash
    # From /Users/javierbenavides/others/dev/poc/domain-obj-port-adapter-sample
    pnpm start:nestjs
    ```
    This executes the compiled `dist/main.js` file. Check the console output or `src/main.ts` for the port number (often defaults to 3000).

3.  **Start the development server (with auto-reload):**
    ```bash
    # From /Users/javierbenavides/others/dev/poc/domain-obj-port-adapter-sample
    pnpm dev:nestjs
    ```
    This uses the NestJS CLI's development server (`nest start --watch`), which typically listens on `http://localhost:3000` and restarts automatically on code changes.

### With AWS SAM

This method uses the AWS SAM CLI to simulate the AWS Lambda and API Gateway environment locally based on the `template.yaml` file. The template uses a proxy integration, forwarding all requests to the NestJS application running within the Lambda environment via `@vendia/serverless-express`.

1.  **Prerequisites:** Ensure you have the [AWS SAM CLI installed](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html) and Docker running.
2.  **Build the project:** (SAM needs the compiled JS files)
    ```bash
    # From /Users/javierbenavides/others/dev/poc/domain-obj-port-adapter-sample
    pnpm build
    ```
3.  **Start the local API:**
    ```bash
    # Navigate to the package directory
    cd packages/aws-lambda-nestjs

    # Start the SAM local API
    sam local start-api -p 3003
    ```
    This command uses the `template.yaml` in the current directory (`packages/aws-lambda-nestjs`) and starts a local API Gateway emulator listening on port 3003.

## CURL Samples

**Note:** Ensure the service is running using one of the methods above before executing these commands. Adjust the port if necessary (default is 3000 for direct run/dev, 3003 for SAM).

**1. Create Transaction**

```bash
# Use port 3000 if running directly, 3003 if using SAM
curl -X POST http://localhost:3000/transactions \
-H "Content-Type: application/json" \
-d '{
  "amount": 99.99,
  "currency": "GBP",
  "description": "Test transaction via NestJS"
}'
```

*Expected Response (example):*
```json
{
  "id": "some-uuid-string",
  "amount": 99.99,
  "currency": "GBP",
  "description": "Test transaction via NestJS",
  "processedAt": "2025-04-22T...Z"
}
```

**2. Get Transaction Details**

Replace `{transactionId}` with an actual ID obtained from the create response.

```bash
# Use port 3000 if running directly, 3003 if using SAM
curl http://localhost:3000/transactions/{transactionId}/details
```

*Expected Response (example):*
```json
{
  "id": "{transactionId}",
  "amount": 99.99,
  "currency": "GBP",
  "description": "Test transaction via NestJS",
  "processedAt": "2025-04-22T...Z"
}
```

**3. Get Non-existent Transaction**

```bash
# Use port 3000 if running directly, 3003 if using SAM
curl -v http://localhost:3000/transactions/invalid-id/details
```

*Expected Response (example):*
```json
{
  "message": "Transaction with ID invalid-id not found",
  "error": "Not Found",
  "statusCode": 404
}
```
(Status code should be 404 - check with `-v` flag in curl)

**4. Create Transaction with Invalid Data**

```bash
# Use port 3000 if running directly, 3003 if using SAM
curl -v -X POST http://localhost:3000/transactions \
-H "Content-Type: application/json" \
-d '{
  "amount": -10,
  "currency": "GB",
  "description": ""
}'
```

*Expected Response (example - NestJS ValidationPipe):*
```json
{
  "message": [
    "amount must be a positive number",
    "currency must be longer than or equal to 3 characters",
    "description should not be empty"
  ],
  "error": "Bad Request",
  "statusCode": 400
}
```
(Status code should be 400 - check with `-v` flag in curl)
